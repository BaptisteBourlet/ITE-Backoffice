<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8" />
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>ALL SERIES - ITE BACK OFFICE MANAGEMENT</title>
   <link rel="stylesheet" type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.0.0/classic/theme-neptune/resources/theme-neptune-all.css" />
   <script src="https://kit.fontawesome.com/ade53cd309.js" crossorigin="anonymous"></script>
   <script type="text/javascript" src="/controller/userAuthServices.js"></script>

   <!-- ----------------------------- DEVELOPMENT ----------------------------- -->
   <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.0.0/ext-all.js"></script> -->

   <!-- ----------------------------- PRODUCTION ------------------------------ -->
   <script type="text/javascript" src="/extjs/ext-all-debug.js"></script>
   <script type="text/javascript" src="/tinymce/tinymce.min.js"></script>
   <style>
      .x-grid-view {
         overflow-y: auto !important;
         position: relative;
      }

      .x-grid-cell-inner {
         overflow: hidden;
         padding: 10px 6px;
         white-space: nowrap;
      }

      .fieldClass {
         border-bottom: 1px dashed rgb(173, 173, 173);
         padding: 7px 0px;
      }

      .a {
         display: block;
      }

      .a span {
         background-color: rgb(253, 253, 253);
         padding: 2px;
         color: black;
      }

      #small-view {
         display: none;
      }

      @media (max-width: 481px) {

         #productDetails,
         #mainPanel {
            display: none !important;
         }

         #small-view {
            margin-top: 4rem;
            font-size: 40px;
            height: 100vh;
            width: 100vw;
            line-height: 50px;
            display: block !important;
         }
      }

      #ENFIELD-legendTitle,
      #ESFIELD-legendTitle,
      #FRFIELD-legendTitle,
      #DEFIELD-legendTitle,
      #RUFIELD-legendTitle {
         font-weight: bold;
      }

      /*Container, container body, iframe*/
      .mce-tinymce,
      .mce-container-body,
      #code_ifr {
         min-height: 100% !important;
      }

      .x-autocontainer-outerCt {
         overflow-y: auto !important;
      }

      .x-boundlist-list-ct {
         overflow-y: auto !important;
      }
   </style>
   <script type="text/javascript">
      //=========================================================================================================
      //		           APPLICATION START
      // ========================================================================================================
      Ext.onReady(() => {
         // Settings
         let tinyHeight = 500;

         // // FOR TESTING 
         // let userRightObject = {
         //    english: "V",
         //    french: "V",
         //    german: "E",
         //    pictures: "V",
         //    related: "E",
         //    russian: "E",
         //    spanish: "E",
         //    usrid: "AG",
         //    usrname: "Ann De Gucht"
         // };

         // let userRightString = JSON.stringify(userRightObject);
         // localStorage.setItem('userRights', userRightString);

         // // =============================================

         let edit = false;
         let serieIDGlobal = '';
         Ext.define('MyApp.view.Form', {
            extend: 'Ext.form.Panel',
            xtype: 'my-form',

         });
         const relatedProducts = (products) => {
            let exist = false;

            for (const prod of products) {
               if (prod.Type === "R") {
                  exist = true;
               }
            }

            if (exist) {
               return products.map((product) => {
                  if (product.Type === "R") {
                     let description = product.Description ? product.Description : product.Title;
                     return {
                        xtype: "toolbar",
                        dock: "top",
                        style: "border: none; margin: 0px; padding: 0px;",
                        items: [
                           {
                              xtype: "button",
                              text: "",
                              iconCls: "fa fa-trash-alt",
                              scale: "small",
                              style: "border: none; margin: 2px;",
                              handler: function () {
                                 Ext.Msg.confirm('Confirm delete', "Are you sure you want to remove this related product ?", function (btn, text) {
                                    if (btn == 'yes') {
                                       Ext.getBody().mask('Deleting', 'x-msg-loading');
                                       Ext.Ajax.request({
                                          url: "/apiSeries/deleteSerieRelatedProductFromDetailsView",
                                          method: "POST",
                                          cors: true,
                                          useDefaultXhrHeader: false,
                                          params: {
                                             Id: product.Id,
                                          },
                                          success: function (response) {
                                             // check for errors and display error message
                                             var check = response.responseText;
                                             if (check) {
                                                var data = eval("(" + response.responseText + ")");

                                                if (data.serverStatus == 2) {
                                                   Ext.getCmp("relatedProducts").removeAll();
                                                   Ext.getCmp("relatedAccessories").removeAll();
                                                   Ext.getCmp("relatedParts").removeAll();
                                                   getSerieDetails(serieIDGlobal);
                                                   Ext.getBody().unmask();
                                                   Ext.Msg.alert(
                                                      "Success",
                                                      "You have successfully deleted the related product"
                                                   );
                                                } else {
                                                   // display error message
                                                   Ext.getBody().unmask();
                                                   Ext.Msg.alert(
                                                      "ERROR",
                                                      "Failed to delete the related product. Contact your IT team."
                                                   );
                                                }
                                             }
                                          },
                                          failure: function (response) {
                                             Ext.getBody().unmask();
                                             Ext.Msg.alert(
                                                "ERROR",
                                                "Failed to delete related product. Contact your IT team."
                                             );
                                          },

                                       });
                                    }
                                 })


                              },
                           }, {

                              xtype: "button",
                              text: `${description} [${product.Code}]`,
                              // cls: "a",
                              style: "border: none; margin: 2px 0px;",
                              handler: () => {
                                 Ext.getCmp("relatedProducts").removeAll();
                                 Ext.getCmp("relatedAccessories").removeAll();
                                 Ext.getCmp("relatedParts").removeAll();
                                 if (product.LinkedSeriesID) {
                                    getSerieDetails(product.LinkedSeriesID);
                                 } else {
                                    getProductDetails(product.LinkedProductID);
                                 }
                                 productIDGlobal = product.LinkedProductID;
                                 // Ext.getCmp("productDetails").setTitle(
                                 //    `PRODUCT DETAILS - ${product.Code}`
                                 // );
                                 // Ext.getCmp("viewport").setActiveItem("productDetails");
                              },

                           }
                        ],

                     }

                  }
               });
            } else {
               return [
                  {
                     xtype: "displayfield",
                     fieldLabel: "<b>Result</b>",
                     value: "No Related Products",
                     labelWidth: 44,
                  },
               ];
            }
         };

         const relatedAccessories = (products) => {
            let exist = false;

            for (const prod of products) {
               if (prod.Type === "A") {
                  exist = true;
               }
            }
            if (exist) {
               return products.map((product) => {
                  if (product.Type === "A") {
                     let description = product.Description ? product.Description : "N/A";
                     return {
                        xtype: "toolbar",
                        dock: "top",
                        style: "border: none; margin: 0px; padding: 0px;",
                        items: [
                           {
                              xtype: "button",
                              text: "",
                              iconCls: "fa fa-trash-alt",
                              scale: "small",
                              style: "border: none; margin: 2px;",
                              handler: function () {
                                 Ext.Msg.confirm('Confirm delete', "Are you sure you want to remove this related product ?", function (btn, text) {
                                    if (btn == 'yes') {
                                       Ext.getBody().mask('Deleting', 'x-msg-loading');
                                       Ext.Ajax.request({
                                          url: "/apiSeries/deleteSerieRelatedProductFromDetailsView",
                                          method: "POST",
                                          cors: true,
                                          useDefaultXhrHeader: false,
                                          params: {
                                             Id: product.Id,

                                          },
                                          success: function (response) {
                                             // check for errors and display error message
                                             var check = response.responseText;
                                             if (check) {
                                                var data = eval("(" + response.responseText + ")");

                                                if (data.serverStatus == 2) {
                                                   Ext.getCmp("relatedProducts").removeAll();
                                                   Ext.getCmp("relatedAccessories").removeAll();
                                                   Ext.getCmp("relatedParts").removeAll();
                                                   getSerieDetails(serieIDGlobal);
                                                   Ext.getBody().unmask();
                                                   Ext.Msg.alert(
                                                      "Success",
                                                      "You have successfully deleted the related product"
                                                   );
                                                } else {
                                                   // display error message
                                                   Ext.getBody().unmask();
                                                   Ext.Msg.alert(
                                                      "ERROR",
                                                      "Failed to delete the related product. Contact your IT team."
                                                   );
                                                }
                                             }
                                          },
                                          failure: function (response) {
                                             Ext.getBody().unmask();
                                             Ext.Msg.alert(
                                                "ERROR",
                                                "Failed to delete related product. Contact your IT team."
                                             );
                                          },

                                       });
                                    }
                                 })


                              },
                           }, {
                              xtype: "button",
                              text: `${description} [${product.Code}]`,
                              cls: "a",
                              style: "border: none; margin: 2px 0px;",
                              handler: () => {
                                 Ext.getCmp("relatedProducts").removeAll();
                                 Ext.getCmp("relatedAccessories").removeAll();
                                 Ext.getCmp("relatedParts").removeAll();
                                 getSerieDetails(product.LinkedProductID ?? product.LinkedSeriesID);
                                 productIDGlobal = product.LinkedProductID;

                              },
                           }
                        ],

                     }

                  }
               });


            } else {
               return [
                  {
                     xtype: "displayfield",
                     fieldLabel: "<b>Result</b>",
                     value: "No Related Accessories",
                     labelWidth: 44,
                  },
               ];
            }
         };

         const relatedParts = (products) => {
            let exist = false;

            for (const prod of products) {
               if (prod.Type === "P") {
                  exist = true;
               }
            }
            if (exist) {
               return products.map((product) => {
                  if (product.Type === "P") {
                     let description = product.Description ? product.Description : "N/A";
                     return {
                        xtype: "toolbar",
                        dock: "top",
                        style: "border: none; margin: 0px; padding: 0px;",
                        items: [
                           {
                              xtype: "button",
                              text: "",
                              iconCls: "fa fa-trash-alt",
                              scale: "small",
                              style: "border: none; margin: 2px;",
                              handler: function () {
                                 Ext.Msg.confirm('Confirm delete', "Are you sure you want to remove this related product ?", function (btn, text) {
                                    if (btn == 'yes') {
                                       Ext.getBody().mask('Deleting', 'x-msg-loading');
                                       Ext.Ajax.request({
                                          url: "/apiSeries/deleteSerieRelatedProductFromDetailsView",
                                          method: "POST",
                                          cors: true,
                                          useDefaultXhrHeader: false,
                                          params: {
                                             Id: product.Id,

                                          },
                                          success: function (response) {
                                             // check for errors and display error message
                                             var check = response.responseText;
                                             if (check) {
                                                var data = eval("(" + response.responseText + ")");

                                                if (data.serverStatus == 2) {
                                                   Ext.getCmp("relatedProducts").removeAll();
                                                   Ext.getCmp("relatedAccessories").removeAll();
                                                   Ext.getCmp("relatedParts").removeAll();
                                                   getSerieDetails(serieIDGlobal);
                                                   Ext.getBody().unmask();
                                                   Ext.Msg.alert(
                                                      "Success",
                                                      "You have successfully deleted the related product"
                                                   );
                                                } else {
                                                   // display error message
                                                   Ext.getBody().unmask();
                                                   Ext.Msg.alert(
                                                      "ERROR",
                                                      "Failed to delete the related product. Contact your IT team."
                                                   );
                                                }
                                             }
                                          },
                                          failure: function (response) {
                                             Ext.getBody().unmask();
                                             Ext.Msg.alert(
                                                "ERROR",
                                                "Failed to delete related product. Contact your IT team."
                                             );
                                          },

                                       });
                                    }
                                 })


                              },
                           }, {
                              xtype: "button",
                              text: `${description} [${product.Code}]`,
                              cls: "a",
                              style: "border: none; margin: 2px 0px;",
                              handler: () => {
                                 Ext.getCmp("relatedProducts").removeAll();
                                 Ext.getCmp("relatedAccessories").removeAll();
                                 Ext.getCmp("relatedParts").removeAll();
                                 getSerieDetails(product.LinkedProductID ?? product.LinkedSeriesID);
                                 productIDGlobal = product.LinkedProductID;;
                              },
                           }
                        ],

                     }

                  }
               });
            } else {
               return [
                  {
                     xtype: "displayfield",
                     fieldLabel: "<b>Result</b>",
                     value: "No Related Parts",
                     labelWidth: 44,
                  },
               ];
            }
         };

         const getSerieDetails = (serieId) => {
            Ext.Ajax.request({
               url: "/apiSeries/getSerieDetails",
               method: "GET",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  serieId: serieId,
               },

               success: function (response) {
                  const res = JSON.parse(response.responseText);
                  Ext.getCmp('seriesIdImage').setValue(serieId);
                  if (edit === false) {
                     displaySerieInfo(res[0][0]);
                  } else {
                     getEditInfo(res[0][0]);
                  }

                  Ext.getCmp("relatedProducts").add(relatedProducts(res[1]));
                  Ext.getCmp("relatedAccessories").add(relatedAccessories(res[1]));
                  Ext.getCmp("relatedParts").add(relatedParts(res[1]));
               },
               failure: function (response) {
                  console.log("failed", response);
               },
            });
         };

         const getProductDetails = (productId) => {
            Ext.Ajax.request({
               url: "/apiSeries/getProductDetails",
               method: "GET",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  productId: productId,
               },

               success: function (response) {
                  const res = JSON.parse(response.responseText);
                  if (edit === false) {

                     Ext.getCmp('productInfoContainer').removeAll();
                     Ext.getCmp('productInfoContainer').add(productDetailItems);
                     displayProductInfo(res[0][0]);
                  }
                  Ext.getCmp("relatedProducts").add(relatedProducts(res[1]));
                  Ext.getCmp("relatedAccessories").add(relatedAccessories(res[1]));
                  Ext.getCmp("relatedParts").add(relatedParts(res[1]));
               },
               failure: function (response) {
                  console.log("failed", response);
               },
            });
         };


         const getEditInfo = (serie) => {

            Ext.getCmp("Title").setValue(serie.Title);
            Ext.getCmp("Key").setValue(serie.Key);
            Ext.getCmp('Category').setValue(serie.CategoryId);
            tinyMCE.get('FDesc').setContent(serie.FullDescription);
            tinyMCE.get('spec').setContent(serie.Specification);

         };


         const displaySerieInfo = (serie) => {

            Ext.getCmp("key").setValue(serie.Key);
            Ext.getCmp("title").setValue(serie.Title);
            Ext.getCmp("fullDescription").setValue(
               serie.FullDescription || "No Full Description"
            );
            Ext.getCmp('Category').setValue(serie.CategoryId);

            Ext.getCmp("specification").setValue(
               serie.Specification || "No Specification"
            );
         };


         const displayProductInfo = (product) => {
            Ext.getCmp("productName").setValue(product.Catalog);
            Ext.getCmp("productCode").setValue(product.CODE);
            Ext.getCmp("as400Code").setValue(product.As400Code);
            Ext.getCmp("as400Description").setValue(product.Description);
            Ext.getCmp("fullDescription").setValue(
               product.FullDescription ?? "No Full Description"
            );
            Ext.getCmp("specification").setValue(
               product.Specification ?? "No Specification"
            );
         };

         const getOtherLanguageDetail = (language, serieId) => {

            Ext.Ajax.request({
               url: "/apiSeries/getOtherLanguageDetailSerie",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  language: language,
                  serieId: serieId,
               },
               success: function (response) {
                  const res = JSON.parse(response.responseText);
                  if (res.length != 0) {
                     Ext.getCmp(`${language.toUpperCase()}Title`).setValue(res[0].Title);

                     if (tinyMCE.get(`${language.toUpperCase()}FDesc`) != null) {
                        tinyMCE.get(`${language.toUpperCase()}FDesc`).setContent(res[0].FullDescription);

                        tinyMCE.get(`${language.toUpperCase()}spec`).setContent(res[0].Specification);
                     }
                  }


               },
               failure: function (response) {
                  console.log("failed", response);
               },
            });
         }

         const addSpecValue = () => {
            const form = Ext.getCmp('addSpecValueForm').getForm();

            if (form.isValid()) {
               Ext.Ajax.request({
                  url: "/apiSeries/addSpecValue",
                  method: "POST",
                  cors: true,
                  useDefaultXhrHeader: false,
                  params: {
                     Key: Ext.getCmp('aaaaaaa').getValue(),
                     Value: Ext.getCmp('aaaaaaa').getValue(),
                     Group: Ext.getCmp('aaaaaaa').getValue(),
                     SubGroup: Ext.getCmp('aaaaaaa').getValue(),
                     SeriesMasterId: Ext.getCmp('aaaaaaa').getValue(),
                  },
                  success: function (response) {
                     const res = JSON.parse(response.responseText)


                  },
                  failure: function (response) {
                     Ext.getBody().unmask();
                     Ext.Msg.alert(
                        "ERROR",
                        "Failed to update Specification. Contact your IT team."
                     );
                  },
               });
            } else {
               Ext.Msg.alert('INFO', "Form is not valid.")
            }
         }

         const Model = Ext.define("Categories", {
            extend: "Ext.data.Model",
            fields: ["Sid", "Key", "Title", "CreatedOn", "ModifiedOn", "Publish"],
         });
         const mainStore = Ext.create("Ext.data.Store", {
            id: "mainStore",
            autoLoad: true,
            model: Model,
            proxy: {
               type: "ajax",
               method: "POST",
               url: "/apiSeries/getAllSeries",
               noCache: true,
               reader: {
                  type: "json",

               },
               cors: true,
               useDefaultXhrHeader: false,
            },
            listeners: {
               beforeload: function (store) { },
            },
         });


         const addSerieMasterSpecs = (serieId) => {
            Ext.Ajax.request({
               url: "/apiSeries/addSerieMasterSpecs",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  serieId: serieId,
                  Key: Ext.getCmp('specKey').getValue(),
                  Group: Ext.getCmp('specGroup').getValue(),
                  SubGroup: Ext.getCmp('specSubGroup').getValue(),
               },
               success: function (response) {
                  const res = JSON.parse(response.responseText);
                  if (res) {
                     Ext.Msg.alert("INFO", "New Specification added successfully");
                     serieMasterStore.reload();
                     Ext.getCmp('viewport').setActiveItem('SeriesMasterSpecs')
                  }
               },
               failure: function (response) {
                  console.log("failed", response);
               },
            });
         }

         const searchSerie = (searchField) => {
            let searchQuery = Ext.getCmp(searchField).getValue();
            Ext.Ajax.request({
               url: "/apiSeries/searchSerie",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  searchQuery: searchQuery,
               },
               success: function (response) {
                  const res = JSON.parse(response.responseText);

                  res
                     ? mainStore.setData(res)
                     : console.log("no response received");
               },
               failure: function (response) {
                  console.log("failed", response);
               },
            });
         };
         //add Series
         let current_datetime = new Date();
         var time = function () {
            if (current_datetime.getMonth() + 1 < 10) {
               return "0" + Number(current_datetime.getMonth() + 1);
            } else {
               current_datetime.getMonth() + 1;
            }
         };

         let formatDate =
            current_datetime.getDate() +
            "/" +
            time() +
            "/" +
            current_datetime.getFullYear();


         var addSerie = function () {
            Ext.getBody().mask("Saving", "x-msg-loading");
            Ext.Ajax.request({
               url: "/apiSeries/addSeries",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  Key: Ext.getCmp("Key").getValue().trim(),
                  CategoryId: Ext.getCmp('Category').getValue(),
                  Language: "en",
                  CreatedOn: formatDate,
                  Title: Ext.getCmp("Title").getValue().trim(),
                  Specification: tinyMCE.get('spec').getContent(),
                  FullDescription: tinyMCE.get('FDesc').getContent(),
                  //FR
                  FRLanguage: "fr",
                  FRTitle: Ext.getCmp("FRTitle").getValue().trim(),
                  FRSpecification: tinyMCE.get('FRspec').getContent(),
                  FRFullDescription: tinyMCE.get('FRFDesc').getContent(),
                  //DE
                  DELanguage: "de",
                  DETitle: Ext.getCmp("DETitle").getValue().trim(),
                  DESpecification: tinyMCE.get('DEspec').getContent(),
                  DEFullDescription: tinyMCE.get('DEFDesc').getContent(),
                  //ES
                  ESLanguage: "es",
                  ESTitle: Ext.getCmp("ESTitle").getValue().trim(),
                  ESSpecification: tinyMCE.get('ESspec').getContent(),
                  ESFullDescription: tinyMCE.get('ESFDesc').getContent(),
                  //RU
                  RULanguage: "ru",
                  RUTitle: Ext.getCmp("RUTitle").getValue().trim(),
                  RUSpecification: tinyMCE.get('RUspec').getContent(),
                  RUFullDescription: tinyMCE.get('RUFDesc').getContent(),
               },
               success: function (response) {
                  // check for errors and display error message
                  var check = response.responseText;
                  if (check) {
                     var data = JSON.parse(check);
                     if (data) {
                        Ext.getBody().unmask();
                        Ext.Msg.alert(
                           "Series",
                           "You have successfully add series",
                           function (btn, text) {
                              Ext.getCmp("viewport").setActiveItem('SeriesGrid');
                           }
                        );
                     } else {
                        // display error message
                        Ext.getBody().unmask();
                        Ext.Msg.alert(
                           "ERROR",
                           "Failed to add the series. Contact your IT team."
                        );
                     }
                  }
               },
               failure: function (response) {
                  Ext.getBody().unmask();
                  Ext.Msg.alert(
                     "ERROR",
                     "Failed to add the series. Contact your IT team."
                  );
               },
            });
         };

         var editSerie = function () {
            //alert(tinyMCE.get('FRspec').getContent());
            //alert(tinyMCE.get('FRFDesc').getContent());
            Ext.getBody().mask("Saving", "x-msg-loading");
            Ext.Ajax.request({
               url: "/apiSeries/editSeries",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  Key: Ext.getCmp("Key").getValue().trim(),
                  CategoryId: Ext.getCmp('Category').getValue(),
                  unlinkCategory: Ext.getCmp('unlinkCategory').getValue() === true ? 1 : 0,
                  SeriesId: serieIDGlobal,
                  Language: "en",
                  ModifiedOn: formatDate,
                  Title: Ext.getCmp("Title").getValue().trim(),
                  Specification: tinyMCE.get('spec').getContent(),
                  FullDescription: tinyMCE.get('FDesc').getContent(),
                  //FR
                  FRLanguage: "fr",
                  FRTitle: Ext.getCmp("FRTitle").getValue().trim(),
                  FRSpecification: tinyMCE.get('FRspec').getContent(),
                  FRFullDescription: tinyMCE.get('FRFDesc').getContent(),
                  //DE
                  DELanguage: "de",
                  DETitle: Ext.getCmp("DETitle").getValue().trim(),
                  DESpecification: tinyMCE.get('DEspec').getContent(),
                  DEFullDescription: tinyMCE.get('DEFDesc').getContent(),
                  //ES
                  ESLanguage: "es",
                  ESTitle: Ext.getCmp("ESTitle").getValue().trim(),
                  ESSpecification: tinyMCE.get('ESspec').getContent(),
                  ESFullDescription: tinyMCE.get('ESFDesc').getContent(),
                  //RU
                  RULanguage: "ru",
                  RUTitle: Ext.getCmp("RUTitle").getValue().trim(),
                  RUSpecification: tinyMCE.get('RUspec').getContent(),
                  RUFullDescription: tinyMCE.get('RUFDesc').getContent(),
               },
               success: function (response) {
                  // check for errors and display error message
                  var check = response.responseText;
                  if (check) {
                     var data = JSON.parse(check);
                     if (data) {
                        Ext.getBody().unmask();
                        Ext.Msg.alert(
                           "Series",
                           `You have successfully edited serie`,
                        );
                        Ext.getCmp("viewport").setActiveItem('SeriesGrid');
                        mainStore.reload();
                     } else {
                        // display error message
                        Ext.getBody().unmask();
                        Ext.Msg.alert(
                           "ERROR",
                           "Failed to add the series. Contact your IT team."
                        );
                     }
                  }
               },
               failure: function (response) {
                  Ext.getBody().unmask();
                  Ext.Msg.alert(
                     "ERROR",
                     "Failed to add the series. Contact your IT team."
                  );
               },
            });
         };


         const linkedProductModel = Ext.define("Categories3", {
            extend: "Ext.data.Model",
            fields: ["Id", "CODE", "Catalog", "Group", "SubGroup"],
         });

         const linkedProductStore = Ext.create("Ext.data.Store", {
            id: "mainStore",
            autoLoad: true,
            model: linkedProductModel,
            proxy: {
               type: "ajax",
               method: "GET",
               url: "/apiSeries/getRelatedProductSerie",
               noCache: true,
               reader: {
                  type: "json",
               },
               cors: true,
               useDefaultXhrHeader: false,
            },
            listeners: {
            },
         });


         let linkedProductColumns = []

         const getRelatedProductSerie = (serieId) => {
            Ext.Ajax.request({
               url: "/apiSeries/getRelatedProductSerie",
               method: "GET",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  serieId: serieId,
               },
               success: function (response) {
                  const res = JSON.parse(response.responseText);

                  let keys = Object.keys(res[0]);

                  let allColumns = keys.map(key => {
                     let width = 150;
                     if (key === 'Name') {
                        width = 300;
                     }

                     if (key !== "Name" && key !== "id" && key !== "Code" && key !== "SPLid" && key !== "SerieMasterId") {
                        return {
                           header: key.slice(0, -1),
                           sortable: true,
                           width: width,
                           dataIndex: key,
                           editor: {
                              completeOnEnter: true,
                              field: {
                                 xtype: "textfield",
                                 allowBlank: false,
                              },
                           },
                           sort: parseInt(key.slice(-1))
                        }
                     } else if (key == "SPLid" || key == "SerieMasterId") {
                        return {
                           header: key,
                           sortable: true,
                           width: width,
                           dataIndex: key,
                           hidden: true
                        }
                     } else {
                        return {
                           header: key,
                           sortable: true,
                           width: width,
                           dataIndex: key,
                           sort: 0,
                        }
                     }
                  })

                  const compare = (a, b) => {
                     if (a.sort < b.sort) {
                        return -1;
                     }
                     if (a.sort > b.sort) {
                        return 1;
                     }
                     return 0;
                  }

                  allColumns.sort(compare);

                  linkedProducts.reconfigure(undefined, allColumns);
                  res
                     ? linkedProductStore.setData(res)
                     : console.log("no response received");
               },
               failure: function (response) {
                  console.log("failed", response);
               },
            });
         }


         const specGroupModel = Ext.define("Categories2", {
            extend: "Ext.data.Model",
            fields: ["Group"],
         });

         const specGroupStore = Ext.create("Ext.data.Store", {
            id: "specGroupStore",
            autoLoad: true,
            model: specGroupModel,
            proxy: {
               type: "ajax",
               method: "GET",
               url: "/apiSeries/getSpecGroup",
               noCache: true,
               reader: {
                  type: "json",
               },
               cors: true,
               useDefaultXhrHeader: false,
            },
            listeners: {
               beforeload: function (store) {
               },
            },
         });


         const CATEGORY = Ext.define("Categories4", {
            extend: "Ext.data.Model",
            fields: ["Id", "Name"],
         });

         const CategoryStore = Ext.create("Ext.data.Store", {
            id: "CategoryStore",
            autoLoad: true,
            model: CATEGORY,
            proxy: {
               type: "ajax",
               method: "POST",
               url: "/apiProducts/getCategories",
               noCache: true,
               reader: {
                  type: "json",
                  rootProperty: "allProducts",
                  totalProperty: "totalCount",
               },
               cors: true,
               useDefaultXhrHeader: false,
            },
         });


         // const serieSpecModel = Ext.define("Categories", {
         //    extend: "Ext.data.Model",
         //    fields: ["SerieMasterId", "Key", "Value"],
         // });

         // const serieSpecStore = Ext.create("Ext.data.Store", {
         //    id: "mainStore",
         //    autoLoad: true,
         //    model: serieSpecModel,
         //    proxy: {
         //       type: "ajax",
         //       method: "GET",
         //       url: "/apiSeries/getSerieSpecs",
         //       noCache: true,
         //       reader: {
         //          type: "json",

         //       },
         //       cors: true,
         //       useDefaultXhrHeader: false,
         //    },
         //    listeners: {
         //       beforeload: function (store) {
         //       },
         //    },
         // });




         // const serieSpecColumn = [
         //    {
         //       header: "SerieMasterId",
         //       sortable: true,
         //       width: 100,
         //       dataIndex: "SerieMasterId",
         //    },
         //    {
         //       header: "Name",
         //       sortable: true,
         //       width: 150,
         //       dataIndex: "Name",
         //    },
         //    {
         //       header: "Current Value",
         //       sortable: true,
         //       width: 150,
         //       dataIndex: "CurrentValue",
         //    },
         //    {
         //       header: "New Value",
         //       sortable: true,
         //       width: 150,
         //       dataIndex: "Value",
         //       editor: {
         //          completeOnEnter: true,
         //          field: {
         //             xtype: "textfield",
         //             allowBlank: false,
         //          },
         //       },
         //    },
         // ]

         var deleteSeries = function () {
            const selectedRecord = Ext.getCmp("SeriesGrid")
               .getSelectionModel()
               .getSelection()[0];
            Ext.Msg.confirm('Confirm delete', "Are you sure you want to remove this series ?", function (btn, text) {
               if (btn == 'yes') {
                  Ext.getBody().mask('Deleting', 'x-msg-loading');
                  Ext.Ajax.request({
                     url: "/apiSeries/deleteSeries",
                     method: "POST",
                     cors: true,
                     useDefaultXhrHeader: false,
                     params: {
                        SeriesId: selectedRecord.data.Sid
                     },
                     success: function (response) {
                        // check for errors and display error message
                        var check = response.responseText;
                        if (check) {
                           var data = eval("(" + response.responseText + ")");

                           if (data.serverStatus == 2) {

                              mainStore.reload();
                              Ext.getBody().unmask();
                              Ext.Msg.alert(
                                 "Success",
                                 "You have successfully deleted the series"
                              );
                           } else {
                              // display error message
                              Ext.getBody().unmask();
                              Ext.Msg.alert(
                                 "ERROR",
                                 "Failed to delete the series. Contact your IT team."
                              );
                           }
                        }
                     },
                     failure: function (response) {
                        Ext.getBody().unmask();
                        Ext.Msg.alert(
                           "ERROR",
                           "Failed to delete series. Contact your IT team."
                        );
                     },

                  });

               }
            })
         }

         const linkedProductTbar = [
            {
               xtype: "toolbar",
               dock: "top",
               id: "linkedProductTbar",
               items: [
                  {
                     xtype: "button",
                     id: "serieLinkBack",
                     text: "Back",
                     iconCls: "fa fa-undo-alt",
                     scale: "small",
                     handler: function () {
                        Ext.getCmp('viewport').setActiveItem('SerieDetails')
                     },
                  },
                  "-",
                  {
                     xtype: "button",
                     id: "addRelatedProducts",
                     text: "Add Linked Product",
                     iconCls: "fa fa-plus",
                     handler: function () {
                        Ext.getCmp("viewport").setActiveItem("panelAddRelated");
                     },
                  },
                  "-",
                  {
                     xtype: "button",
                     id: "deleteRelatedProducts",
                     text: "Delete Linked Product",
                     iconCls: "fa fa-trash",
                     handler: function () {
                        Ext.Msg.confirm('Confirm delete', "Are you sure you want to remove this related product ?", function (btn, text) {
                           if (btn == 'yes') {
                              var selectedrecords = linkedProducts.getSelectionModel().getSelection();
                              var teller = selectedrecords.length;
                              currentsubfileRecord = selectedrecords[0];
                              Ext.getBody().mask("Saving", "x-msg-loading");
                              Ext.Ajax.request({
                                 url: "/apiSeries/deleteSerieRelatedProduct",
                                 method: "POST",
                                 cors: true,
                                 useDefaultXhrHeader: false,
                                 params: {
                                    SeriesId: serieIDGlobal,
                                    ProductId: currentsubfileRecord.data.id,
                                    SeriesMasterId: currentsubfileRecord.data.SerieMasterId,
                                    SPLid: currentsubfileRecord.data.SPLid
                                 },
                                 success: function (response) {
                                    // check for errors and display error message
                                    var check = response.responseText;
                                    if (check) {
                                       var data = eval("(" + response.responseText + ")");
                                       if (data.serverStatus == 2) {

                                          Ext.getBody().unmask();
                                          Ext.Msg.alert(
                                             "Success",
                                             "You have successfully delete the related product"
                                          );
                                          linkedProductStore.reload()
                                       } else {
                                          // display error message
                                          Ext.getBody().unmask();
                                          Ext.Msg.alert(
                                             "ERROR",
                                             "Failed to delete the related product. Contact your IT team."
                                          );
                                       }
                                    }
                                 },
                                 failure: function (response) {
                                    Ext.getBody().unmask();
                                    Ext.Msg.alert(
                                       "ERROR",
                                       "Failed to delete the related product. Contact your IT team."
                                    );
                                 },
                              });
                           }
                        },
                        )
                     }
                  }
               ],


            },
         ];

         const mainGridColumns = [
            {
               header: "ID",
               sortable: true,
               width: 80,
               dataIndex: "Sid",
               align: 'center'
            },
            {
               header: "Tree",
               sortable: true,
               width: 100,
               dataIndex: "Tree",
               align: 'center'
            },
            {
               header: "Key",
               sortable: false,
               width: 150,
               dataIndex: "Key",
               align: 'center'
            },
            {
               header: "Title",
               sortable: false,
               width: 300,
               dataIndex: "Title",
            },

         ];

         const tbarItems = [
            {
               xtype: "toolbar",
               dock: "top",
               id: "bottomToolBar",
               items: [
                  {
                     xtype: "button",
                     id: "add",
                     iconCls: "fa fa-plus-circle",
                     text: "New",
                     scale: "small",
                     handler: function () {
                        Ext.getCmp('tabTrans').setActiveTab(0)
                        Ext.getCmp("addSave").setHidden(false);
                        Ext.getCmp("editSave").setHidden(true);
                        Ext.getCmp("panelAdd").setTitle("Add series");
                        Ext.getCmp("viewport").setActiveItem("panelAdd");
                        Ext.getCmp('addForm').reset();
                        tinymce.init({
                           selector: 'textarea',
                           plugins: [

                              'advlist autolink lists link image charmap print preview anchor',

                              'searchreplace visualblocks code fullscreen',

                              'insertdatetime media table paste code help wordcount'

                           ],
                           // // menubar: 'true',
                           toolbar: 'undo redo |  ' +

                              'bold italic forecolor | alignleft aligncenter ' +

                              ' | bullist numlist outdent indent | ' +

                              ' table | link image | removeformat  code | help',
                           height: '350',
                           content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }'
                        });
                     },
                  },
                  "-",
                  {
                     xtype: "button",
                     id: "overviewEdit",
                     text: "Edit",
                     iconCls: "fa fa-edit",
                     scale: "small",
                     handler: function () {
                        edit = false
                        const selectedRecord = Ext.getCmp("SeriesGrid")
                           .getSelectionModel()
                           .getSelection()[0];

                        getSerieDetails(selectedRecord.data.Sid);
                        serieIDGlobal = selectedRecord.data.Sid;
                        edit = true;


                        if (selectedRecord === undefined) {
                           Ext.Msg.alert("INFO", "No record selected");
                        } else {

                           Ext.getCmp("addSave").setHidden(true);
                           Ext.getCmp("editSave").setHidden(false);
                           Ext.getCmp("panelAdd").setTitle("Edit Serie (a)");
                           Ext.getCmp("viewport").setActiveItem("panelAdd");

                           // Load different tabs to allow saving everthing
                           Ext.getCmp('tabTrans').setActiveTab(1);
                           Ext.getCmp('tabTrans').setActiveTab(2);
                           Ext.getCmp('tabTrans').setActiveTab(3);
                           Ext.getCmp('tabTrans').setActiveTab(4);
                           Ext.getCmp('tabTrans').setActiveTab(0);
                           serieIDGlobal = selectedRecord.data.Sid;
                           // if tinyMCE fields are allready innitated
                           if (tinyMCE.get(`spec`) != null) {
                              getSerieDetails(serieIDGlobal);
                           }
                           if (tinyMCE.get(`DEspec`) != null) {
                              getOtherLanguageDetail('de', serieIDGlobal);
                           }
                           if (tinyMCE.get(`FRspec`) != null) {
                              getOtherLanguageDetail('fr', serieIDGlobal);
                           }
                           if (tinyMCE.get(`ESspec`) != null) {
                              getOtherLanguageDetail('es', serieIDGlobal);
                           }
                           if (tinyMCE.get(`RUspec`) != null) {
                              getOtherLanguageDetail('ru', serieIDGlobal);
                           }
                           tinymce.init({
                              selector: 'textarea',

                              plugins: [
                                 'advlist autolink lists link image charmap print preview anchor',
                                 'searchreplace visualblocks code fullscreen',
                                 'insertdatetime media table paste code help wordcount'
                              ],
                              // menubar: 'true',
                              toolbar: 'undo redo |  ' +
                                 'bold italic forecolor | alignleft aligncenter ' +
                                 ' | bullist numlist outdent indent | ' +
                                 ' table | link image | removeformat  code | help',
                              height: '350',
                              content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }',
                              setup: function (editor) {
                                 editor.on('init', function (e) {


                                    if (tinyMCE.get(`spec`) != null) {
                                       getSerieDetails(serieIDGlobal);
                                    }
                                    if (tinyMCE.get(`DEspec`) != null) {
                                       getOtherLanguageDetail('de', serieIDGlobal);
                                    }
                                    if (tinyMCE.get(`FRspec`) != null) {
                                       getOtherLanguageDetail('fr', serieIDGlobal);
                                    }
                                    if (tinyMCE.get(`ESspec`) != null) {
                                       getOtherLanguageDetail('es', serieIDGlobal);
                                    }
                                    if (tinyMCE.get(`RUspec`) != null) {
                                       getOtherLanguageDetail('ru', serieIDGlobal);
                                    }
                                 });
                              },
                           });
                        }
                     },
                  },
                  "-",
                  {
                     xtype: "button",
                     id: "delete",
                     text: "Delete",
                     iconCls: "fa fa-trash-alt",
                     scale: "small",
                     handler: function () { deleteSeries() },
                  },
                  "-",
                  {
                     xtype: "button",
                     id: "viewLinkedImage",
                     text: "View Linked Images",
                     iconCls: "fas fa-images",
                     scale: "small",
                     handler: function () {
                        const selectedRecord = Ext.getCmp("SeriesGrid")
                           .getSelectionModel()
                           .getSelection()[0];
                        if (selectedRecord) {
                           const SeriesId = selectedRecord.data['Sid'];
                           linkedImageStore.getProxy().setExtraParam('Id', SeriesId);
                           linkedImageStore.reload();
                           Ext.getCmp('viewport').setActiveItem('linkedImageGrid');
                        } else {
                           Ext.Msg.alert('INFO', 'No Series selected')
                        }
                     },
                  },
               ],
            },
            {
               xtype: "toolbar",
               dock: "top",
               id: "searchBar",
               items: [
                  {
                     xtype: "textfield",
                     id: "searchKey",
                     iconCls: "fa fa-search",
                     width: 200,
                     labelWidth: 20,
                     style: "margin-left: 5px; color: grey;",
                     emptyText: "Search by key",
                     listeners: {
                        change: () => {
                           searchSerie("searchKey")
                        },
                     },
                  },

                  {
                     xtype: "button",
                     id: "resetSearch",
                     iconCls: "fas fa-undo-alt",
                     text: "reset",
                     style: "padding: 7px; border: none; background-color: #000",
                     listeners: {
                        click: () => {
                           Ext.getCmp("searchKey").setValue("");
                           mainStore.reload();
                        },
                     },
                  },
               ],
            },
         ];

         var TabTranslations = Ext.create('Ext.TabPanel', {
            fullscreen: true,
            tabBarPosition: 'bottom',
            id: 'tabTrans',
            width: "100%",
            defaults: {
               styleHtmlContent: true
            },
            listeners: {
               render: function () {
                  this.items.each(function (i) {
                     // Ext.getCmp('tabTrans').setActiveTab(i);
                     i.tab.on('click', function () {
                        Ext.getCmp('tabTrans').setActiveTab(i)
                        //  getOtherLanguageDetail('fr', serieIDGlobal)
                        //  getOtherLanguageDetail('de', serieIDGlobal)
                        //  getOtherLanguageDetail('es', serieIDGlobal)
                        //  getOtherLanguageDetail('ru', serieIDGlobal)
                     });
                  })
               },
            },
            items: [
               {
                  title: 'English',
                  items: [
                     {
                        xtype: "fieldset",
                        title: "English Translations",
                        anchor: "100%",
                        hidden: false,
                        id: "ENFIELD",
                        layoutConfig: {
                           // The total column count must be specified here
                           columns: 9,
                        },
                        items: [
                           {
                              layout: {
                                 type: 'hbox',
                                 align: 'stretch'
                              },
                              border: false,
                              items: [
                                 {
                                    xtype: 'my-form',
                                    width: '70%',
                                    frame: false,
                                    border: false,
                                    items: [
                                       {
                                          xtype: "textfield",
                                          id: "Title",
                                          name: "Title",
                                          fieldLabel: "Title",
                                          maxLenght: 46,
                                          width: 500,
                                          allowBlank: false,
                                          submitvalue: true,
                                          margin: "25 0 25 0",
                                       },

                                       {

                                          html: '<h4>Full description :</h4><textarea id="FDesc"></textarea>',
                                          height: tinyHeight,
                                       },

                                       {
                                          html: '<h4>Specification :</h4><textarea id="spec"></textarea>',
                                          height: tinyHeight,

                                       },
                                    ]
                                 }
                              ]
                           },
                        ],
                     },
                  ]
               },
               {
                  title: 'French',

                  items: [
                     {
                        xtype: "fieldset",
                        title: "French Translations",
                        anchor: "100%",
                        hidden: false,
                        id: "FRFIELD",
                        layoutConfig: {
                           // The total column count must be specified here
                           columns: 9,
                        },
                        items: [
                           {
                              layout: {
                                 type: 'hbox',
                                 align: 'stretch'
                              },
                              border: false,
                              items: [
                                 {
                                    xtype: 'my-form',
                                    width: '70%',
                                    frame: false,
                                    border: false,
                                    items: [
                                       {
                                          xtype: "textfield",
                                          id: "FRTitle",
                                          name: "FRTitle",
                                          fieldLabel: "Title",
                                          maxLenght: 46,
                                          width: 500,
                                          allowBlank: true,
                                          submitvalue: true,
                                          margin: "25 0 25 0",
                                       },

                                       {
                                          html: '<h4>Full description :</h4><textarea id="FRFDesc"></textarea>',
                                          height: tinyHeight,

                                       },

                                       {
                                          html: '<h4>Specification :</h4><textarea id="FRspec"></textarea>',
                                          height: tinyHeight,

                                       },
                                    ]
                                 }
                              ]
                           },
                        ],
                     },
                  ]
               },
               {
                  title: 'German',

                  items: [
                     {
                        xtype: "fieldset",
                        title: "German Translations",
                        anchor: "100%",
                        hidden: false,
                        id: "DEFIELD",
                        layoutConfig: {
                           // The total column count must be specified here
                           columns: 9,
                        },
                        items: [
                           {
                              layout: {
                                 type: 'hbox',
                                 align: 'stretch'
                              },
                              border: false,
                              items: [
                                 {
                                    xtype: 'my-form',
                                    width: '70%',
                                    frame: false,
                                    border: false,
                                    items: [
                                       {
                                          xtype: "textfield",
                                          id: "DETitle",
                                          name: "DETitle",
                                          fieldLabel: "Title",
                                          maxLenght: 46,
                                          width: 500,
                                          allowBlank: true,
                                          submitvalue: true,
                                          margin: "25 0 25 0",
                                       },

                                       {
                                          html: '<h4>Full description :</h4><textarea id="DEFDesc"></textarea>',
                                          height: tinyHeight,

                                       },

                                       {

                                          html: '<h4>Specification :</h4><textarea id="DEspec"></textarea>',
                                          height: tinyHeight,

                                       },
                                    ]
                                 }
                              ]
                           },
                        ],
                     },
                  ]
               },
               {
                  title: 'Spanish',

                  items: [
                     {
                        xtype: "fieldset",
                        labelStyle: "font-weight: bold; ",
                        title: "Spanish Translations",
                        anchor: "100%",
                        hidden: false,
                        id: "ESFIELD",
                        layoutConfig: {
                           // The total column count must be specified here
                           columns: 9,
                        },
                        items: [
                           {
                              layout: {
                                 type: 'hbox',
                                 align: 'stretch'
                              },
                              border: false,
                              items: [
                                 {
                                    xtype: 'my-form',
                                    width: '70%',
                                    frame: false,
                                    border: false,
                                    items: [
                                       {
                                          xtype: "textfield",
                                          id: "ESTitle",
                                          name: "ESTitle",
                                          fieldLabel: "Title",
                                          allowBlank: true,
                                          maxLenght: 46,
                                          width: 500,
                                          submitvalue: true,
                                          margin: "25 0 25 0",
                                       },

                                       {
                                          html: '<h4>Full description :</h4><textarea id="ESFDesc"></textarea>',
                                          height: tinyHeight,

                                       },

                                       {
                                          html: '<h4>Specification :</h4><textarea id="ESspec"></textarea>',
                                          height: tinyHeight,

                                       },
                                    ]
                                 }
                              ]
                           },
                        ],
                     },
                  ]
               },
               {
                  title: 'Russian',

                  items: [
                     {
                        xtype: "fieldset",
                        title: "Russian Translations",
                        anchor: "100%",
                        hidden: false,
                        id: "RUFIELD",
                        layoutConfig: {
                           // The total column count must be specified here
                           columns: 9,
                        },
                        items: [
                           {
                              layout: {
                                 type: 'hbox',
                                 align: 'stretch'
                              },
                              border: false,
                              items: [
                                 {
                                    xtype: 'my-form',
                                    width: '70%',
                                    frame: false,
                                    border: false,
                                    items: [
                                       {
                                          xtype: "textfield",
                                          id: "RUTitle",
                                          name: "RUTitle",
                                          fieldLabel: "Title",
                                          maxLenght: 46,
                                          allowBlank: true,
                                          width: 500,
                                          submitvalue: true,
                                          margin: "25 0 25 0",
                                       },

                                       {
                                          html: '<h4>Full description :</h4><textarea id="RUFDesc"></textarea>',
                                          height: tinyHeight,

                                       },

                                       {
                                          html: '<h4>Specification :</h4><textarea id="RUspec"></textarea>',
                                          height: tinyHeight,

                                       },
                                    ]
                                 }
                              ]
                           },
                        ],
                     },
                  ]
               },
            ]
         });

         var itemsAdd = [

            {
               xtype: "textfield",
               id: "Key",
               name: "Key",
               fieldLabel: "Key",
               maxLenght: 26,
               width: 500,
               allowBlank: true,
               selectOnFocus: false,
               margin: "25 0 25 0",
            },
            {
               xtype: "combo",
               id: "Category",
               name: "Category",
               store: CategoryStore,
               width: 500,
               fieldLabel: "Category",
               displayField: "Name",
               valueField: "Id",
               allowBlank: true,
               selectOnFocus: false,
               anyMatch: true,
               queryMode: "local",
               listeners: {
                  change: () => {
                     let categoryValue = Ext.getCmp('Category').getValue();
                     if (categoryValue) {
                        Ext.getCmp('unlinkCategory').setValue(false)
                     }
                  }
               }
            },
            {
               xtype: "checkbox",
               id: "unlinkCategory",
               name: "unlinkCategory",
               fieldLabel: "Unlink From Any Category",
               width: 500,
               labelWidth: 190,
               allowBlank: true,
               selectOnFocus: false,
               listeners: {
                  change: () => {
                     let unlink = Ext.getCmp('unlinkCategory').getValue();
                     if (unlink) {
                        Ext.getCmp('Category').setValue('')
                     }
                  }
               }
            },

            TabTranslations


         ];

         var screenAdd = new Ext.FormPanel({
            frame: false,
            header: false,
            border: false,
            defaults: {
               labelAlign: "right",
               labelWidth: 105,
               listeners: {
                  specialkey: function (field, e) {
                     if (e.getKey() == e.ENTER) {
                        updateRec();
                     }
                     if (e.getKey() == e.ESC) {
                        Ext.getCmp("viewport").setActiveItem("SeriesGrid");
                     }
                  },
               },
            },
            width: '100%',
            waitMsgTarget: true,
            autoScroll: true,
            style: "padding: 3px 3px 3px 3px;",
            items: [
               {
                  layout: "column",
                  layoutConfig: {
                     columns: 2,
                  },
                  border: false,
                  items: [
                     {
                        xtype: 'my-form',
                        id: "addForm",
                        columnWidth: 1,
                        border: false,
                        items: itemsAdd,
                     },
                  ],
               },
            ],
         });

         // outer panel container to hold tbar and keypress definitions
         var panelAdd = new Ext.Panel({
            layout: "fit",
            id: "panelAdd",
            title: "Add product",
            header: true,
            items: [screenAdd],
            tbar: [
               {

                  text: "Save",
                  id: "addSave",
                  iconCls: "fas fa-save",
                  handler: function () {
                     if (Ext.getCmp('addForm').isValid()) {
                        Ext.getCmp('tabTrans').setActiveTab(1)
                        tinymce.init({
                           selector: 'textarea',
                           plugins: [

                              'advlist autolink lists link image charmap print preview anchor',

                              'searchreplace visualblocks code fullscreen',

                              'insertdatetime media table paste code help wordcount'

                           ],
                           // menubar: 'true',
                           toolbar: 'undo redo |  ' +

                              'bold italic forecolor | alignleft aligncenter ' +

                              ' | bullist numlist outdent indent | ' +

                              ' table | link image | removeformat  code | help',
                           height: '350',
                           content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }'
                        });
                        Ext.getCmp('tabTrans').setActiveTab(2)
                        tinymce.init({
                           selector: 'textarea',
                           plugins: [

                              'advlist autolink lists link image charmap print preview anchor',

                              'searchreplace visualblocks code fullscreen',

                              'insertdatetime media table paste code help wordcount'

                           ],
                           // menubar: 'true',
                           toolbar: 'undo redo |  ' +

                              'bold italic forecolor | alignleft aligncenter ' +

                              ' | bullist numlist outdent indent | ' +

                              ' table | link image | removeformat  code | help',
                           height: '350',
                           content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }'
                        });
                        Ext.getCmp('tabTrans').setActiveTab(3)
                        tinymce.init({
                           selector: 'textarea',
                           plugins: [

                              'advlist autolink lists link image charmap print preview anchor',

                              'searchreplace visualblocks code fullscreen',

                              'insertdatetime media table paste code help wordcount'

                           ],
                           // menubar: 'true',
                           toolbar: 'undo redo |  ' +

                              'bold italic forecolor | alignleft aligncenter ' +

                              ' | bullist numlist outdent indent | ' +

                              ' table | link image | removeformat  code | help',
                           height: '350',
                           content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }'
                        });
                        Ext.getCmp('tabTrans').setActiveTab(4)
                        tinymce.init({
                           selector: 'textarea',
                           plugins: [

                              'advlist autolink lists link image charmap print preview anchor',

                              'searchreplace visualblocks code fullscreen',

                              'insertdatetime media table paste code help wordcount'

                           ],
                           // menubar: 'true',
                           toolbar: 'undo redo |  ' +

                              'bold italic forecolor | alignleft aligncenter ' +

                              ' | bullist numlist outdent indent | ' +

                              ' table | link image | removeformat  code | help',
                           height: '350',
                           content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }'
                        });
                        addSerie();
                        Ext.getCmp("relatedProducts").removeAll();
                        Ext.getCmp("relatedAccessories").removeAll();
                        Ext.getCmp("relatedParts").removeAll();
                        Ext.getCmp('addForm').reset()
                     }
                  },
               },
               {
                  text: "Save",
                  id: "editSave",
                  iconCls: "fas fa-save",
                  handler: function () {
                     if (Ext.getCmp('addForm').isValid()) {
                        edit = false;
                        //start debug
                        //alert('save data handler')
                        //end debug
                        editSerie();
                        Ext.getCmp("relatedProducts").removeAll();
                        Ext.getCmp("relatedAccessories").removeAll();
                        Ext.getCmp("relatedParts").removeAll();
                        Ext.getCmp("addForm").reset();
                     }
                  },
               },
               "-",
               {
                  text: "Cancel",
                  tooltip: "Cancel",
                  id: 'cancel',
                  iconCls: "fas fa-undo",
                  handler: function () {
                     edit = false;
                     Ext.getCmp('tabTrans').setActiveTab(1)
                     // tinyMceInitiation
                     tinymce.init({
                        selector: 'textarea',
                        plugins: [

                           'advlist autolink lists link image charmap print preview anchor',

                           'searchreplace visualblocks code fullscreen',

                           'insertdatetime media table paste code help wordcount'

                        ],
                        // menubar: 'true',
                        toolbar: 'undo redo |  ' +

                           'bold italic forecolor | alignleft aligncenter ' +

                           ' | bullist numlist outdent indent | ' +

                           ' table | link image | removeformat  code | help',
                        height: '350',
                        content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }'
                     });
                     tinyMCE.get('FRFDesc').setContent('');
                     tinyMCE.get('FRspec').setContent('');
                     Ext.getCmp('tabTrans').setActiveTab(2)
                     // tinyMceInitiation
                     tinymce.init({
                        selector: 'textarea',
                        plugins: [

                           'advlist autolink lists link image charmap print preview anchor',

                           'searchreplace visualblocks code fullscreen',

                           'insertdatetime media table paste code help wordcount'

                        ],
                        // menubar: 'true',
                        toolbar: 'undo redo |  ' +

                           'bold italic forecolor | alignleft aligncenter ' +

                           ' | bullist numlist outdent indent | ' +

                           ' table | link image | removeformat  code | help',
                        height: '350',
                        content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }'
                     });
                     tinyMCE.get('DEFDesc').setContent('');
                     tinyMCE.get('DEspec').setContent('');
                     Ext.getCmp('tabTrans').setActiveTab(3)
                     // tinyMceInitiation
                     tinymce.init({
                        selector: 'textarea',
                        plugins: [

                           'advlist autolink lists link image charmap print preview anchor',

                           'searchreplace visualblocks code fullscreen',

                           'insertdatetime media table paste code help wordcount'

                        ],
                        // menubar: 'true',
                        toolbar: 'undo redo |  ' +

                           'bold italic forecolor | alignleft aligncenter ' +

                           ' | bullist numlist outdent indent | ' +

                           ' table | link image | removeformat  code | help',
                        height: '350',
                        content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }'
                     });
                     tinyMCE.get('ESFDesc').setContent('');
                     tinyMCE.get('ESspec').setContent('');
                     Ext.getCmp('tabTrans').setActiveTab(4)
                     // tinyMceInitiation
                     tinymce.init({
                        selector: 'textarea',
                        plugins: [

                           'advlist autolink lists link image charmap print preview anchor',

                           'searchreplace visualblocks code fullscreen',

                           'insertdatetime media table paste code help wordcount'

                        ],
                        // menubar: 'true',
                        toolbar: 'undo redo |  ' +

                           'bold italic forecolor | alignleft aligncenter ' +

                           ' | bullist numlist outdent indent | ' +

                           ' table | link image | removeformat  code | help',
                        height: '350',
                        content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }'
                     });

                     tinyMCE.get('RUFDesc').setContent('');
                     tinyMCE.get('RUspec').setContent('');
                     Ext.getCmp("relatedProducts").removeAll();
                     Ext.getCmp("relatedAccessories").removeAll();
                     Ext.getCmp("relatedParts").removeAll();
                     Ext.getCmp('addForm').reset();
                     Ext.getCmp("viewport").setActiveItem("SeriesGrid");
                  },
               },
            ],
         });

         const SeriesGrid = Ext.create("Ext.grid.GridPanel", {
            id: "SeriesGrid",
            bufferedRenderer: false,
            flex: 1,
            scrollable: true,
            title: "All Series",
            trackOver: true,
            loadMask: true,
            store: mainStore,
            columns: mainGridColumns,
            enableColumnMove: false,
            sortable: true,
            frame: false,
            renderTo: Ext.getBody(),
            height: 690,
            dockedItems: [...tbarItems],
            listeners: {
               dblclick: {
                  element: "body",
                  fn: () => {
                     const selectedRecord = Ext.getCmp("SeriesGrid")
                        .getSelectionModel()
                        .getSelection()[0];

                     serieIDGlobal = selectedRecord.data.Sid;
                     sessionStorage.setItem('serieIDGlobal', serieIDGlobal)
                     getSerieDetails(selectedRecord.data.Sid);

                     linkedProductStore.getProxy().setExtraParam('serieId', selectedRecord.data.Sid);
                     linkedProductStore.load();

                     Ext.getCmp("viewport").setActiveItem("SerieDetails");

                     serieMasterStore.getProxy().setExtraParam('Sid', selectedRecord.data.Sid)
                     SeriesMasterSpecs.setTitle('Serie master specs - ' + selectedRecord.data.Key)
                  },
               },
            },
         });

         const serieDetailItems = [
            {
               xtype: "displayfield",
               id: "key",
               fieldLabel: "<b>Serie</b>",
               labelWidth: 150,
               fieldCls: "fieldClass",
            },
            {
               xtype: "displayfield",
               id: "title",
               labelWidth: 150,
               fieldLabel: "<b>Serie Title</b>",
               fieldCls: "fieldClass",
            },
            {
               xtype: "displayfield",
               id: "fullDescription",
               fieldLabel: "<b>Full Description</b>",
               labelWidth: 150,
               fieldCls: "fieldClass",
            },
            {
               xtype: "displayfield",
               id: "specification",
               fieldLabel: "<b>Specification</b>",
               labelWidth: 150,
               fieldCls: "fieldClass",
            },
         ]


         const productDetailItems = [
            {
               xtype: "displayfield",
               id: "productName",
               fieldLabel: "<b>Product</b>",
               labelWidth: 150,
               fieldCls: "fieldClass",
            },
            {
               xtype: "displayfield",
               id: "productCode",
               labelWidth: 150,
               fieldLabel: "<b>Product Code</b>",
               fieldCls: "fieldClass",
            },
            {
               xtype: "displayfield",
               id: "as400Code",
               fieldLabel: "<b>AS400CODE</b>",
               labelWidth: 150,
               fieldCls: "fieldClass",
            },
            {
               xtype: "displayfield",
               id: "as400Description",
               fieldLabel: "<b>AS/400 Description</b>",
               labelWidth: 150,
               fieldCls: "fieldClass",
            },
            {
               xtype: "displayfield",
               id: "fullDescription",
               fieldLabel: "<b>Full Description</b>",
               labelWidth: 150,
               fieldCls: "fieldClass",
            },
            {
               xtype: "displayfield",
               id: "specification",
               fieldLabel: "<b>Specification</b>",
               labelWidth: 150,
               fieldCls: "fieldClass",
            },
         ]

         const SerieDetails = Ext.create("Ext.panel.Panel", {
            id: "SerieDetails",
            title: "SERIE DETAILS",
            flex: 1,
            trackOver: true,
            loadMask: true,
            header: true,
            scrollable: true,
            layout: "border",
            items: [
               {
                  xtype: "container",
                  width: 420,
                  scrollable: true,
                  style: "background-color: white;",
                  region: "east",
                  layout: {
                     type: "vbox",
                     align: "stretch",
                  },
                  items: [
                     {
                        xtype: "panel",
                        title: "Related Products",
                        id: "relatedProducts",
                        dockedItems: [],
                     },
                     {
                        xtype: "panel",
                        title: "Related Accessories",
                        id: "relatedAccessories",
                        items: [],
                     },
                     {
                        xtype: "panel",
                        title: "Related Parts",
                        id: "relatedParts",
                        items: [],
                     },
                  ],
               },
               {
                  xtype: "panel",
                  title: "Serie Info",
                  region: "center",
                  scrollable: true,
                  style: "padding-left: 20px; background-color: white;",
                  id: "productInfoContainer",
                  layout: {
                     type: "vbox",
                     align: "stretch",
                  },
                  items: serieDetailItems
               },
            ],
            dockedItems: [
               {
                  xtype: "toolbar",
                  dock: "top",
                  id: "productDetailBar",
                  items: [
                     {
                        xtype: "button",
                        id: "cancel2",
                        text: "Back",
                        iconCls: "fa fa-undo-alt",
                        handler: function () {
                           edit = false;
                           Ext.getCmp("relatedProducts").removeAll();
                           Ext.getCmp("relatedAccessories").removeAll();
                           Ext.getCmp("relatedParts").removeAll();
                           Ext.getCmp("viewport").setActiveItem("SeriesGrid");
                        },
                     },
                     "-",
                     {
                        xtype: "button",
                        id: "editDetail",
                        text: "Edit",
                        iconCls: "fa fa-edit",
                        handler: function () {
                           edit = true;
                           Ext.getCmp("addSave").setHidden(true);
                           Ext.getCmp("editSave").setHidden(false);
                           Ext.getCmp('panelAdd').setTitle('Edit Serie (b)');
                           Ext.getCmp("viewport").setActiveItem("panelAdd");
                           // Load different tabs to allow saving everthing
                           Ext.getCmp('tabTrans').setActiveTab(1);
                           Ext.getCmp('tabTrans').setActiveTab(2);
                           Ext.getCmp('tabTrans').setActiveTab(3);
                           Ext.getCmp('tabTrans').setActiveTab(4);
                           Ext.getCmp('tabTrans').setActiveTab(0);

                           // if tinyMCE fields are allready innitated
                           if (tinyMCE.get(`spec`) != null) {
                              getSerieDetails(serieIDGlobal);
                           }
                           if (tinyMCE.get(`DEspec`) != null) {
                              getOtherLanguageDetail('de', serieIDGlobal);
                           }
                           if (tinyMCE.get(`FRspec`) != null) {
                              getOtherLanguageDetail('fr', serieIDGlobal);
                           }
                           if (tinyMCE.get(`ESspec`) != null) {
                              getOtherLanguageDetail('es', serieIDGlobal);
                           }
                           if (tinyMCE.get(`RUspec`) != null) {
                              getOtherLanguageDetail('ru', serieIDGlobal);
                           }
                           tinymce.init({
                              selector: 'textarea',

                              plugins: [
                                 'advlist autolink lists link image charmap print preview anchor',
                                 'searchreplace visualblocks code fullscreen',
                                 'insertdatetime media table paste code help wordcount'
                              ],
                              // menubar: 'true',
                              toolbar: 'undo redo |  ' +
                                 'bold italic forecolor | alignleft aligncenter ' +
                                 ' | bullist numlist outdent indent | ' +
                                 ' table | link image | removeformat  code | help',
                              height: '350',
                              content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:13px }',
                              setup: function (editor) {
                                 editor.on('init', function (e) {
                                    if (this.id == 'spec') {
                                       getSerieDetails(serieIDGlobal);
                                    }
                                    if (this.id == 'ENspec') {
                                       getOtherLanguageDetail('en', serieIDGlobal);
                                    }
                                    if (this.id == 'DEspec') {
                                       getOtherLanguageDetail('de', serieIDGlobal);
                                    }
                                    if (this.id == 'FRspec') {
                                       getOtherLanguageDetail('fr', serieIDGlobal);
                                    }
                                    if (this.id == 'ESspec') {
                                       getOtherLanguageDetail('es', serieIDGlobal);
                                    }
                                    if (this.id == 'RUspec') {
                                       getOtherLanguageDetail('ru', serieIDGlobal);
                                    }
                                 });
                              },
                           });
                           Ext.getCmp("relatedProducts").removeAll();
                           Ext.getCmp("relatedAccessories").removeAll();
                           Ext.getCmp("relatedParts").removeAll();

                        },
                     },
                     "-",
                     {
                        xtype: "button",
                        id: "addImageBtn",
                        text: "Add Image",
                        iconCls: "fa fa-plus",
                        handler: function () {
                           Ext.getCmp('viewport').setActiveItem('imagePanel');
                        },
                     },
                     "-",
                     {
                        xtype: "button",
                        id: "linkedProductsBtn",
                        text: "View Linked Products",
                        iconCls: "fa fa-tasks",
                        handler: function () {
                           getRelatedProductSerie(serieIDGlobal);
                           Ext.getCmp("viewport").setActiveItem("linkedProducts");
                        },
                     },
                     "-",
                     {
                        xtype: "button",
                        id: "addRelatedProducts2",
                        text: "Add Related Product",
                        iconCls: "fa fa-plus",
                        handler: function () {
                           //Ext.getCmp('fromViewSave').setHidden(false);
                           //Ext.getCmp('fromAddSave').setHidden(true);
                           Ext.getCmp("viewport").setActiveItem("panelAdd2");
                        },
                     },
                     "-",
                     {
                        xtype: "button",
                        id: "viewSerieMaster",
                        text: "View Serie Master specs",
                        iconCls: "fa fa-tasks",
                        handler: function () {
                           serieMasterStore.load();

                           Ext.getCmp("viewport").setActiveItem("SeriesMasterSpecs");

                        },
                     },
                  ],
               },
            ],
         });





         //<!-- ----------------------------------------------------------------------- -->
         //<!--                           Add related product                           -->
         //<!-- ----------------------------------------------------------------------- -->
         var addSeriesRelatedProd = function () {
            Ext.getBody().mask("Saving", "x-msg-loading");
            Ext.Ajax.request({
               url: "/apiSeries/addSeriesRelatedProduct",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  SeriesId: serieIDGlobal,
                  ProductId: Ext.getCmp("ProductIdRelated").getValue(),
               },
               success: function (response) {
                  // check for errors and display error message
                  var check = response.responseText;
                  if (check) {
                     var data = eval("(" + response.responseText + ")");
                     if (data.serverStatus == 2) {
                        Ext.getBody().unmask();
                        //  Ext.Msg.alert(
                        //     "Success",
                        //     "You have successfully add the related product"
                        //  );
                     } else {
                        // display error message
                        Ext.getBody().unmask();
                        Ext.Msg.alert(
                           "ERROR",
                           "Failed to add the related product. Contact your IT team."
                        );
                     }
                  }
               },
               failure: function (response) {
                  Ext.getBody().unmask();
                  Ext.Msg.alert(
                     "ERROR",
                     "Failed to add the related product. Contact your IT team."
                  );
               },
            });
         };


         const ProductDet = Ext.define("ProductDet", {
            extend: "Ext.data.Model",
            fields: ["CODE", "Id"],
         });

         const ProductDetStore = Ext.create("Ext.data.Store", {
            id: "ProductDetStore",
            autoLoad: true,
            model: ProductDet,

            proxy: {

               type: "ajax",
               method: "POST",
               url: "/apiSeries/getProductDet",
               noCache: true,
               reader: {
                  type: "json",
               },
               cors: true,
               useDefaultXhrHeader: false,
            },
         });


         const getRelatedCatalog = (ProductId, from, SerOrProd) => {
            Ext.Ajax.request({
               url: "/apiSeries/getRelatedCatalog",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  ProductId: ProductId,
                  SerProd: SerOrProd
               },
               success: function (response) {
                  const res = JSON.parse(response.responseText);

                  if (from === 'itemsAdd2') {
                     console.log(res[0].Catalog)
                     Ext.getCmp("RPCatalog").setValue(res[0].Catalog);


                  } else {
                     Ext.getCmp("ProductCatalog").setValue(res[0].Catalog);
                  }
               },
               failure: function (response) {
                  console.log("failed", response);
               },
            });
         };

         var itemsAddRelated = [
            {
               xtype: "combo",
               id: "ProductIdRelated",
               name: "ProductIdRelated",
               store: ProductDetStore,
               width: 200,
               fieldLabel: "Product",
               displayField: "CODE",
               valueField: "Id",
               anchor: "30%",
               allowBlank: false,
               selectOnFocus: false,
               anyMatch: true,
               queryMode: "local",
               listeners: {
                  select: function () {
                     let ProductId = this.getValue();
                     getRelatedCatalog(ProductId, 'itemAddRelated');
                  }
               }
            },
            {
               xtype: 'displayfield',
               id: 'ProductCatalog',
               fieldLabel: "Product description",
            }
         ]

         var screenAddRelated = new Ext.FormPanel({
            frame: false,
            header: false,
            border: false,
            defaults: {
               labelAlign: "right",
               labelWidth: 105,
               listeners: {
                  specialkey: function (field, e) {
                     if (e.getKey() == e.ENTER) {
                        updateRec();
                     }
                     if (e.getKey() == e.ESC) {
                        Ext.getCmp("viewport").setActiveItem("SeriesGrid");
                     }
                  },
               },
            },
            width: 500,
            waitMsgTarget: true,
            autoScroll: true,
            style: "padding: 3px 3px 3px 3px;",
            items: [
               {
                  layout: "column",
                  layoutConfig: {
                     columns: 2,
                  },
                  border: false,
                  items: [
                     {
                        xtype: 'my-form',
                        id: "itemsAddRelatedForm",
                        columnWidth: 0.9,
                        border: false,
                        items: itemsAddRelated,
                     },
                  ],
               },
            ],
         });

         var panelAddRelated = new Ext.Panel({
            layout: "fit",
            id: "panelAddRelated",
            title: "Add product to a serie",
            header: true,
            items: [screenAddRelated],
            tbar: [
               {
                  text: "Back",
                  tooltip: "Back",
                  id: 'cancel3',
                  iconCls: "fas fa-undo",
                  handler: function () {
                     edit = false;
                     Ext.getCmp('itemsAddRelatedForm').reset();

                     Ext.getCmp("viewport").setActiveItem("SerieDetails");
                  },
               },
               "-",
               {
                  text: "Save",
                  id: "addRelatedSave",
                  iconCls: "fas fa-save",
                  handler: function () {
                     let linkedProductID = Ext.getCmp('ProductIdRelated').getValue()
                     let exist = false;

                     Array.from(linkedProductStore.data.items).forEach(product => {
                        if (product.data.id === linkedProductID) {
                           exist = true;
                        }
                     });

                     if (exist) {
                        Ext.Msg.alert('INFO', 'This product is already linked');
                     } else {
                        addSeriesRelatedProd();

                        Ext.getCmp('addForm2').reset();
                        linkedProductStore.reload()
                        Ext.getCmp("viewport").setActiveItem("linkedProducts");
                     }
                  },
               },

            ],
         });

         const linkedProducts = Ext.create("Ext.grid.GridPanel", {
            id: "linkedProducts",
            bufferedRenderer: false,
            flex: 1,
            scrollable: true,
            title: "Linked Products",
            trackOver: true,
            loadMask: true,
            store: linkedProductStore,
            columns: linkedProductColumns,
            enableColumnMove: false,
            sortable: true,
            frame: false,
            // renderTo: Ext.getBody(),
            height: 690,
            dockedItems: [...linkedProductTbar],
            selModel: 'cellmodel',
            plugins: {
               ptype: 'cellediting',
               clicksToEdit: 1
            },
         });

         linkedProducts.on("edit", (editor, event) => {
            let modifiedRecords = linkedProductStore.getModifiedRecords();

            if (modifiedRecords.length !== 0) {
               let key = Object.keys(linkedProductStore.getModifiedRecords()[0].modified);
               let value = linkedProductStore.getModifiedRecords()[0].data[key]
               let SPLid = linkedProductStore.getModifiedRecords()[0].data['SPLid'];
               let sequence = key[0].slice(-1);
               key = key[0].slice(0, -1);
               let GroupArray = key.split('--');
               let Group = GroupArray[0];
               let SubGroup = GroupArray[1];
               let regEx = new RegExp("\\\\", "g");
               let hasBlacklash = regEx.test(value);

               if (value.includes("'") || hasBlacklash) {
                  Ext.Msg.alert('INFO', `Input value cannot contain <b> single quote (') </b> or <b>backlash (\\)</b> `)
               } else {
                  Ext.Ajax.request({
                     url: "/apiSeries/updateSerieSpecs",
                     method: "POST",
                     cors: true,
                     useDefaultXhrHeader: false,
                     params: {
                        Sid: serieIDGlobal,
                        key: Group,
                        value: value,
                        SPLid: SPLid,
                        Group: Group,
                        SubGroup: SubGroup,
                        masterSequence: sequence
                     },
                     success: function (response) {

                        linkedProductStore.reload();
                     },
                     failure: function (response) {
                        Ext.getBody().unmask();
                        Ext.Msg.alert(
                           "ERROR",
                           "Failed to update Specification. Contact your IT team."
                        );
                     },
                  });
               }
            }
         })

         // const SerieSpecs = Ext.create("Ext.grid.GridPanel", {
         //    id: "SerieSpecs",
         //    flex: 1,
         //    scrollable: true,
         //    title: "Managing Serie Specs",
         //    trackOver: true,
         //    loadMask: true,
         //    store: serieSpecStore,
         //    columns: serieSpecColumn,
         //    enableColumnMove: false,
         //    selModel: 'cellmodel',
         //    plugins: {
         //       ptype: 'cellediting',
         //       clicksToEdit: 1
         //    },
         //    sortable: true,
         //    frame: false,
         //    renderTo: Ext.getBody(),
         //    height: 690,
         //    dockedItems: [
         //       {
         //          xtype: "toolbar",
         //          dock: "top",
         //          id: "toolBar",
         //          items: [
         //             {
         //                xtype: "button",
         //                id: "serieSpecBack",
         //                text: "Back",
         //                iconCls: "fa fa-undo-alt",
         //                scale: "small",
         //                handler: function () {
         //                   Ext.getCmp('viewport').setActiveItem('linkedProducts')
         //                },
         //             },
         //             "-",
         //             {
         //                xtype: "button",
         //                id: "specValueAdd",
         //                text: "Add Specs Value",
         //                iconCls: "fa fa-plus",
         //                scale: "small",
         //                handler: function () {
         //                   Ext.getCmp('viewport').setActiveItem('specValueAddPanel')
         //                },
         //             },
         //             "-",
         //             {
         //                xtype: "button",
         //                id: "serieSpecSave",
         //                text: "Save",
         //                iconCls: "fas fa-save",
         //                scale: "small",
         //                handler: function () {
         //                   let updatedRecords = serieSpecStore.getModifiedRecords();
         //                   if (updatedRecords.length === 0) {
         //                      Ext.Msg.alert("INFO", "You haven't made any changes");
         //                   } else {
         //                      saveSpecEdit(updatedRecords);
         //                   }
         //                },
         //             },
         //          ],
         //       },
         //    ],
         // });


         // <!-- ----------------------------------------------------------------------- -->
         // <!--                           GRID SERIES MASTER                            -->
         // <!-- ----------------------------------------------------------------------- -->

         const tbarItemsMaster = [
            {
               xtype: "toolbar",
               dock: "top",
               id: "bottomToolBarMaster",
               items: [
                  {
                     xtype: "button",
                     id: "MasterBack",
                     text: "Back",
                     iconCls: "fa fa-undo-alt",
                     scale: "small",
                     handler: function () {
                        Ext.getCmp('viewport').setActiveItem('SerieDetails')
                     },
                  },
                  '-',
                  {
                     xtype: "button",
                     id: "addNewSpecs",
                     text: "Add Serie Master Specs",
                     iconCls: "fa fa-plus",
                     handler: function () {
                        Ext.getCmp('viewport').setActiveItem('addSerieSpecs')
                     }
                  },
                  '-',
                  {
                     xtype: "button",
                     id: "deleteMasterSpecs",
                     text: "Delete Serie Master Specs",
                     iconCls: "fa fa-trash-alt",
                     handler: function () {
                        const selectedRecord = SeriesMasterSpecs.getSelectionModel().getSelection()[0];
                        if (selectedRecord) {
                           Ext.Msg.confirm("Confirm", `Do you want to delete this Series Master?`, (btn) => {
                              if (btn == 'yes') {
                                 Ext.getBody().mask('Deleting', 'x-msg-loading');
                                 Ext.Ajax.request({
                                    url: "/apiSeries/deleteSeriesMasterSpecs",
                                    method: "POST",
                                    cors: true,
                                    useDefaultXhrHeader: false,
                                    params: {
                                       Id: selectedRecord.data['Id']
                                    },
                                    success: function (response) {
                                       let res = JSON.parse(response.responseText);
                                       serieMasterStore.reload();
                                       Ext.getBody().unmask();
                                    },
                                    failure: function (response) {
                                       Ext.getBody().unmask();
                                       Ext.Msg.alert(
                                          "ERROR",
                                          "Failed to update Specification. Contact your IT team."
                                       );
                                    },
                                 });
                              }
                           })
                        } else {
                           Ext.Msg.alert('INFO', 'No Master Specs selected');
                        }
                     }
                  }
               ]
            }
         ]


         const ModelSerieMaster = Ext.define("Categories5", {
            extend: "Ext.data.Model",
            fields: ["Id", "Key", "Group", "SubGroup", "Sequence"],
         });
         const serieMasterStore = Ext.create("Ext.data.Store", {
            id: "serieMasterStore",
            autoLoad: false,
            model: ModelSerieMaster,
            proxy: {
               type: "ajax",
               method: "GET",
               url: "/apiSeries/getSerieMaster",
               noCache: true,
               reader: {
                  type: "json",

               },
               cors: true,
               useDefaultXhrHeader: false,
            },
            listeners: {
               beforeload: function (store) {

               },
            },
         });

         const serieMasterColumns = [
            {
               header: "Serie master ID",
               sortable: true,
               width: 150,
               dataIndex: "Id"
            },
            {
               header: "Key",
               sortable: true,
               width: 200,
               dataIndex: "Key",
            },
            {
               header: "Group",
               sortable: true,
               width: 150,
               dataIndex: "Group"
            },
            {
               header: "Sub group",
               sortable: true,
               width: 150,
               dataIndex: "SubGroup",
               editor: {
                  completeOnEnter: true,
                  field: {
                     xtype: "textfield",
                     allowBlank: true,
                  },
               },
            },
            {
               header: "Sequence",
               sortable: true,
               width: 100,
               dataIndex: "Sequence",
               editor: {
                  completeOnEnter: true,
                  field: {
                     xtype: "numberfield",
                     allowBlank: false,
                  },
               },
            },
         ]


         const SeriesMasterSpecs = Ext.create("Ext.grid.GridPanel", {
            id: "SeriesMasterSpecs",
            bufferedRenderer: false,
            flex: 1,
            scrollable: true,
            title: "Serie master specs",
            trackOver: true,
            loadMask: true,
            store: serieMasterStore,
            columns: serieMasterColumns,
            enableColumnMove: false,
            sortable: true,
            frame: false,
            height: 690,
            selModel: 'cellmodel',
            plugins: {
               ptype: 'cellediting',
               clicksToEdit: 1
            },
            dockedItems: [...tbarItemsMaster],
            listeners: {
               dblclick: {
                  element: "body",
                  fn: () => {

                  },
               },
            },
         });


         SeriesMasterSpecs.on('edit', (editor, event) => {
            Ext.getBody().mask('Updating', 'x-msg-loading');
            Ext.Ajax.request({
               url: "/apiSeries/updateSequenceSeriesMaster",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  Id: event.record.data.Id,
                  Sequence: event.record.data.Sequence,
                  SubGroup: event.record.data.SubGroup,
               },
               success: function (response) {
                  let result = JSON.parse(response.responseText);
                  Ext.getBody().unmask();
               },
               failure: function (response) {
                  Ext.getBody().unmask();
                  Ext.Msg.alert(
                     "ERROR",
                     "Failed to delete related product. Contact your IT team."
                  );
               },
            })
         })


         const addSerieSpecs = Ext.create('Ext.panel.Panel', {
            id: "addSerieSpecs",
            layout: 'fit',
            title: 'Add New Specs',
            tbar: [
               {
                  xtype: "button",
                  text: "Back",
                  id: "addSpecBack",
                  iconCls: "fa fa-undo-alt",
                  handler: function () {
                     Ext.getCmp('addSpecForm').reset();
                     Ext.getCmp('viewport').setActiveItem('SeriesMasterSpecs');
                  }
               },
               '-',
               {
                  xtype: "button",
                  text: "Save",
                  id: "addSpecSave",
                  iconCls: "fa fa-save",
                  handler: function () {
                     addSerieMasterSpecs(serieIDGlobal);
                     Ext.getCmp('addSpecForm').reset();
                  }
               },

            ],
            items: [
               {
                  xtype: "form",
                  id: "addSpecForm",
                  frame: true,
                  border: false,
                  scrollable: true,
                  layout: "anchor",
                  defaults: {
                     anchor: "30%",
                  },
                  items: [
                     {
                        xtype: 'textfield',
                        id: 'specKey',
                        style: "margin: 10px 0px;",
                        fieldLabel: 'Key',
                     },
                     {
                        xtype: 'combo',
                        id: 'specGroup',
                        style: "margin: 10px 0px;",
                        fieldLabel: 'Group',
                        store: specGroupStore,
                        displayField: 'Group',
                        valueField: 'Group',
                        mode: 'local',
                        anyMatch: true
                     },
                     {
                        xtype: 'textfield',
                        id: 'specSubGroup',
                        style: "margin: 10px 0px;",
                        fieldLabel: 'Sub Group',
                     },
                  ],
               },
            ]
         })


         const specValueAddPanel = Ext.create('Ext.panel.Panel', {
            id: "specValueAddPanel",
            layout: 'fit',
            title: 'Add New Specs Value',
            tbar: [
               {
                  xtype: "button",
                  text: "Back",
                  id: "addSpecValueBack",
                  iconCls: "fa fa-undo-alt",
                  handler: function () {
                     Ext.getCmp('viewport').setActiveItem('SerieSpecs');
                     Ext.getCmp('addSpecValueForm').reset();
                  }
               },
               "-",
               {
                  xtype: "button",
                  text: "Save",
                  id: "addSpecValueSave",
                  iconCls: "fa fa-save",
                  handler: function () {
                     addSpecValue();
                     Ext.getCmp('addSpecValueForm').reset();
                  }
               },
            ],
            items: [
               {
                  xtype: "form",
                  id: "addSpecValueForm",
                  frame: true,
                  border: false,
                  scrollable: true,
                  layout: "anchor",
                  defaults: {
                     anchor: "30%",
                  },
                  items: [
                     {
                        xtype: 'textfield',
                        id: 'specValueKey',
                        style: "margin: 10px 0px;",
                        fieldLabel: 'Key',
                        allowBlank: false,
                     },
                     {
                        xtype: 'textfield',
                        id: 'specValueValue',
                        style: "margin: 10px 0px;",
                        fieldLabel: 'Value',
                        allowBlank: false,
                     },
                     {
                        xtype: 'combo',
                        id: 'specValueGroup',
                        style: "margin: 10px 0px;",
                        fieldLabel: 'Group',
                        store: specGroupStore,
                        displayField: 'Group',
                        valueField: 'Group',
                        mode: 'local',
                        anyMatch: true,
                        allowBlank: true,
                     },
                     {
                        xtype: 'textfield',
                        id: 'specValueSubGroup',
                        style: "margin: 10px 0px;",
                        fieldLabel: 'Sub Group',
                        allowBlank: true,
                     },
                  ],
               },
            ]

         })



         const imagePanel = Ext.create('Ext.panel.Panel', {
            id: "imagePanel",
            layout: 'fit',
            title: 'Upload image',
            items: [
               {
                  xtype: "form",
                  id: "imageForm",
                  frame: true,
                  border: false,
                  scrollable: true,
                  viewModel: {},
                  layout: "anchor",
                  defaults: {
                     anchor: "30%",
                  },
                  items: [
                     {
                        xtype: 'filefield',
                        accept: 'image/*',
                        id: 'image',
                        name: 'image',
                        fieldLabel: 'Select an Image',
                        style: "margin: 10px 0px;",
                        allowBlank: false
                     },
                     {
                        xtype: 'displayfield',
                        id: 'seriesIdImage',
                        name: 'seriesIdImage',
                        style: "margin: 10px 0px;",
                        hidden: true
                     },
                     {
                        xtype: 'textfield',
                        id: 'imageLabel',
                        name: 'imageLabel',
                        style: "margin: 10px 0px;",
                        fieldLabel: 'Label',
                        allowBlank: true
                     },
                  ],
               },
            ],
            tbar: [
               {
                  text: "Back",
                  id: "imageBack",
                  iconCls: "fas fa-undo",
                  handler: function () {
                     Ext.getCmp('viewport').setActiveItem('SerieDetails');
                  }
               },
               "-",
               {
                  text: "Upload",
                  id: "upload",
                  iconCls: "fas fa-save",
                  handler: function () {
                     var form = Ext.getCmp('imageForm')
                     if (form.isValid()) {
                        form.submit({
                           url: '/apiSeries/uploadSerieImage',
                           headers: { 'Content-Type': 'multipart/form-data' },
                           method: "POST",
                           waitMsg: 'Uploading your photo...',
                           params: {
                              SeriesId: Ext.getCmp('seriesIdImage').getValue(),
                              Label: Ext.getCmp('imageLabel').getValue(),
                           },
                           success: function (fp, object) {
                              form.reset();
                              Ext.Msg.alert('Success', 'Your photo "' + object.result.file + '" has been uploaded.');
                           },
                           failure: (fp, object) => {
                              if (object.result.isExist == "yes") {
                                 Ext.Msg.alert('Failed', "This file already exist, please change the name");
                              } else {
                                 Ext.Msg.alert('Failed', "failed to upload image, please contact your IT Team");
                              }
                           }
                        });
                     } else {
                        Ext.Msg.alert("INFO", "Form is not valid!")
                     }
                  },
               },
            ]
         })


         // <!-- ------------------------- ADD RELATED PRODUCT ------------------------- -->

         var addRelatedProdFromView = function (globalProductID) {
            Ext.getBody().mask("Saving", "x-msg-loading");
            Ext.Ajax.request({
               url: "/apiSeries/addRelatedProductFromSeriesView",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  Type: Ext.getCmp("Type").getValue(),
                  LinkedProductID: Ext.getCmp("ProductDesc").getValue(),
                  serieIDGlobal: serieIDGlobal,
                  Code: Ext.getCmp("ProductDesc").getRawValue(),
                  Catalog: Ext.getCmp("RPCatalog").getValue(),
                  ProdSer: Ext.getCmp('ProdSer').getValue()
               },
               success: function (response) {
                  // check for errors and display error message
                  var check = response.responseText;
                  if (check) {
                     var data = eval("(" + response.responseText + ")");
                     if (data.serverStatus == 2) {
                        Ext.getBody().unmask();
                        Ext.Msg.alert(
                           "Success",
                           "You have successfully add the related product"
                        );
                     } else {
                        // display error message
                        Ext.getBody().unmask();
                        Ext.Msg.alert(
                           "ERROR",
                           "Failed to add the related product. Contact your IT team."
                        );
                     }
                  }
               },
               failure: function (response) {
                  Ext.getBody().unmask();
                  Ext.Msg.alert(
                     "ERROR",
                     "Failed to add the related product. Contact your IT team."
                  );
               },
            });
         };

         var TypeStore = Ext.create("Ext.data.Store", {
            fields: ["TypeCode", "TypeName"],
            data: [
               { TypeCode: "P", TypeName: "Spare part" },
               { TypeCode: "A", TypeName: "Accessory" },
               { TypeCode: "R", TypeName: "Related product" },
            ],
            storeId: "TypeStore",
         });

         var ProdSerStore = Ext.create("Ext.data.Store", {
            fields: ["ProdSerCode", "ProdSerName"],
            data: [
               { ProdSerCode: "P", ProdSerName: "Product" },
               { ProdSerCode: "S", ProdSerName: "Serie" }
            ],
            storeId: "ProdSerStore",
         });



         var itemsAdd2 = [
            {
               xtype: "combo",
               id: "Type",
               name: "Type",
               store: TypeStore,
               width: 300,
               fieldLabel: "Type",
               displayField: "TypeName",
               valueField: "TypeCode",
               allowBlank: false,
               selectOnFocus: false,
               editable: false,
            },
            {
               xtype: "combo",
               id: "ProdSer",
               name: "ProdSer",
               store: ProdSerStore,
               width: 300,
               fieldLabel: "Product/Serie",
               displayField: "ProdSerName",
               valueField: "ProdSerCode",
               allowBlank: false,
               selectOnFocus: false,
               editable: false,
               listeners: {
                  change: function () {
                     ProductDetStore.getProxy().setExtraParam('ProdSer', this.getValue());
                     ProductDetStore.reload()
                  },
               },
            },
            {
               xtype: "combo",
               id: "ProductDesc",
               name: "ProductDesc",
               store: ProductDetStore,
               width: 300,
               fieldLabel: "Product",
               displayField: "CODE",
               valueField: "Id",
               allowBlank: false,
               selectOnFocus: false,
               anyMatch: true,
               queryMode: "local",
               listeners: {
                  click: {

                     fn: function () {
                        if (Ext.getCmp('ProdSer').getValue() == '' || Ext.getCmp('ProdSer').getValue() == undefined) {
                           Ext.Msg.alert(
                              "INFO",
                              "Please choose if it is a product or a serie."
                           );
                        }
                     }
                  },

                  change: function () {

                     let SerOrProd = Ext.getCmp('ProdSer').getValue()
                     let ProductId = this.getValue();
                     getRelatedCatalog(ProductId, 'itemsAdd2', SerOrProd);
                  },
               },
            },
            {
               xtype: "textfield",
               id: "RPCatalog",
               name: "RPCatalog",
               width: 600,
               fieldLabel: "Product description",
               editable: false,
               hideTrigger: true,
               allowBlank: true,
               selectOnFocus: false,
            },
         ];

         var screenAdd2 = new Ext.FormPanel({
            frame: false,
            header: false,
            border: false,
            id: "screenAdd2",
            defaults: {
               labelAlign: "right",
               labelWidth: 105,
            },
            width: 1200,
            waitMsgTarget: true,
            autoScroll: true,
            style: "padding: 3px 3px 3px 3px;",
            items: [
               {
                  layout: "column",
                  layoutConfig: { columns: 2 },
                  border: false,
                  items: [
                     {
                        xtype: 'my-form',
                        id: "addForm2",
                        columnWidth: 0.9,
                        border: false,
                        items: itemsAdd2,
                     },
                  ],
               },
            ],
         });

         const resetForm2 = () => {
            Ext.getCmp('Type').setValue('');
            Ext.getCmp('ProductDesc').setValue('');
            Ext.getCmp('ProdSer').setValue('');
            Ext.getCmp('RPCatalog').setValue('');
         }

         // outer panel container to hold tbar and keypress definitions
         var panelAdd2 = new Ext.Panel({
            layout: "fit",
            id: "panelAdd2",
            title: "Add Related Product",
            header: true,
            items: [screenAdd2],
            tbar: [
               {
                  text: "Cancel",
                  tooltip: "Cancel",
                  iconCls: "fas fa-undo",
                  handler: function () {
                     resetForm2();
                     Ext.getCmp("addForm").reset();
                     Ext.getCmp("viewport").setActiveItem("SerieDetails");
                     Ext.getCmp("relatedProducts").removeAll();
                     Ext.getCmp("relatedAccessories").removeAll();
                     Ext.getCmp("relatedParts").removeAll();
                  },
               },
               '-',

               {
                  text: "Save",
                  id: "fromViewSave",
                  iconCls: "fas fa-save",
                  handler: function () {
                     if (Ext.getCmp('addForm2').isValid()) {
                        addRelatedProdFromView();
                        resetForm2();
                        Ext.getCmp("relatedProducts").removeAll();
                        Ext.getCmp("relatedAccessories").removeAll();
                        Ext.getCmp("relatedParts").removeAll();
                        getSerieDetails(serieIDGlobal);
                        Ext.getCmp("viewport").setActiveItem("SerieDetails");
                     }
                  },
               },

            ],
         });



         const linkedImageModel = Ext.define("Images", {
            extend: "Ext.data.Model",
            fields: ["Id", "Type", "Size", "Path", "Sequence"],
         });

         const linkedImageStore = Ext.create("Ext.data.Store", {
            id: "linkedImageStore",
            autoLoad: true,
            model: linkedImageModel,
            proxy: {
               type: "ajax",
               method: "GET",
               url: "/apiSeries/getLinkedImage",
               noCache: true,
               reader: {
                  type: "json",
               },
               cors: true,
               useDefaultXhrHeader: false,
            },
            listeners: {
               beforeload: function (store) {
               },
            },
         });

         const linkedImageColumns = [
            {
               header: "ID",
               sortable: true,
               width: 50,
               dataIndex: "Id",
               align: 'center'
            },
            {
               header: "Type",
               sortable: true,
               width: 100,
               dataIndex: "Type",
               align: 'left'
            },
            {
               header: "Image",
               sortable: true,
               width: 170,
               dataIndex: "Path",
               align: 'left',
               renderer: (value) => {
                  return `<img src="/pictures/${value}" width="150" height="150">`;
               }
            },
            {
               header: "Sequence",
               sortable: true,
               width: 120,
               dataIndex: "Sequence",
               align: 'left',
               editor: {
                  completeOnEnter: true,
                  field: {
                     xtype: "numberfield",
                     allowBlank: false,

                  },
               },
            },
         ]

         const linkedImageGrid = Ext.create("Ext.grid.GridPanel", {
            id: "linkedImageGrid",
            bufferedRenderer: false,
            flex: 1,
            scrollable: true,
            title: "Linked Images",
            trackOver: true,
            loadMask: true,
            store: linkedImageStore,
            columns: linkedImageColumns,
            enableColumnMove: false,
            sortable: true,
            frame: false,
            renderTo: Ext.getBody(),
            height: 690,
            dockedItems: [
               {
                  xtype: "toolbar",
                  dock: "top",
                  id: "linkedImageToolBar",
                  items: [
                     {
                        xtype: "button",
                        id: "linkedImageBack",
                        iconCls: "fa fa-undo-alt",
                        text: "Back",
                        scale: "small",
                        handler: function () {
                           Ext.getCmp('viewport').setActiveItem('SeriesGrid')
                        },
                     },
                  ],
               },
            ],
            plugins: {
               ptype: 'cellediting',
               clicksToEdit: 1
            },
         });

         linkedImageGrid.on('edit', (editor, event) => {
            Ext.getBody().mask('Updating', 'x-msg-loading');
            Ext.Ajax.request({
               url: "/apiSeries/updateImageSequence",
               method: "POST",
               cors: true,
               useDefaultXhrHeader: false,
               params: {
                  Id: event.record.data.Id,
                  Sequence: event.record.data.Sequence,
               },
               success: function (response) {
                  let result = JSON.parse(response.responseText);
                  Ext.getBody().unmask();
               },
               failure: function (response) {
                  Ext.getBody().unmask();
                  Ext.Msg.alert(
                     "ERROR",
                     "Failed to delete related product. Contact your IT team."
                  );
               },

            });


         })


         let userRights = JSON.parse(localStorage.getItem('userRights'));

         if (userRights !== null) {
            applyUserRights(userRights);
         }

         //=========================================================================================================
         //		           VIEW PORT
         // ========================================================================================================

         Ext.create("Ext.container.Viewport", {
            id: "viewport",
            layout: "card",
            activeItem: 'SeriesGrid',
            items: [SeriesGrid, SerieDetails, panelAdd, panelAdd2, panelAddRelated, linkedProducts, addSerieSpecs, SeriesMasterSpecs, specValueAddPanel, imagePanel, linkedImageGrid],
         });
      });
   </script>
</head>

<body>
   <div id="small-view">
      This Appplication is not meant for small devices.
   </div>
</body>

</html>